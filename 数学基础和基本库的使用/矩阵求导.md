#  矩阵求导

## 1. 布局法

### 1.1 向量对标量求导

标量$y$对标量$x$的求导，可以表示为$\frac{\partial y}{\partial x}$。

一组标量$y_i,i=1,2,...,m$来对一个标量$x$的求导,那么我们会得到一组标量求导的结果：$$\frac{\partial y_i}{\partial x}, i=1,2.,,,m$$

将标量y写成向量形式, 即得到维度为m的一个向量$\mathbf{y}$对一个标量$x$的求导，那么结果也是一个m维的向量：$\frac{\partial \mathbf{y}}{\partial x}$

向量对标量的求导，其实就是向量里的每个分量分别对标量求导，最后把求导的结果排列在一起，按一个向量表示而已。类似的结论也存在于标量对向量的求导，向量对向量的求导，向量对矩阵的求导，矩阵对向量的求导，以及矩阵对矩阵的求导等。所谓的向量矩阵求导本质上就是多元函数求导，仅仅是把把函数的自变量，因变量以及标量求导的结果排列成了向量矩阵的形式，方便表达与计算，更加简洁而已

求导的自变量用$x$表示标量，$\mathbf{x}$表示n维向量，$\mathbf{X}$表示$m \times n$维度的矩阵，求导的因变量用$y$表示标量，$\mathbf{y}$表示m维向量，$\mathbf{Y}$表示$p \times q$维度的矩阵.

### 1.2 向量求导布局

- 分子布局(numerator layout): 求导结果的维度以分子为主, 分子为列向量或者分母为行向量. 如果向量$\mathbf{y}$是一个m维的列向量，那么求导结果$\frac{\partial \mathbf{y}}{\partial x}$也是一个m维列向量。如果如果向量$\mathbf{y}$是一个m维的行向量，那么求导结果$\frac{\partial \mathbf{y}}{\partial x}$也是一个m维行向量

- 分母布局(denominator layout ): 求导结果的维度以分母为主, 分子为行向量或者分母为列向量. 如果向量$\mathbf{y}$是一个m维的列向量，那么求导结果$\frac{\partial \mathbf{y}}{\partial x}$是一个m维行向量。如果如果向量$\mathbf{y}$是一个m维的行向量，那么求导结果$\frac{\partial \mathbf{y}}{\partial x}$是一个m维的列向量。

对于分子布局和分母布局的结果来说，两者相差一个转置。

- 标量$y$对矩阵$ \mathbf{X}$求导，那么如果按分母布局，则求导结果的维度和矩阵$X$的维度$m \times n$是一致的。如果是分子布局，则求导结果的维度为$n \times m$。

- 向量对向量的求导: m维列向量$\mathbf{y}$对n维列向量$\mathbf{x}$求导。对于这2个向量求导，那么一共有$mn$个标量对标量的求导。求导的结果一般是排列为一个矩阵。

  + 如果是分子布局，则矩阵的第一个维度以分子为准，即结果是一个$m \times n$的矩阵，如下：$$ \frac{\partial  \mathbf{y}}{\partial \mathbf{x}} = \left( \begin{array}{ccc} \frac{\partial y_1}{\partial x_1}& \frac{\partial y_1}{\partial x_2}& \ldots & \frac{\partial y_1}{\partial x_n}\\  \frac{\partial y_2}{\partial x_1}& \frac{\partial y_2}{\partial x_2} & \ldots & \frac{\partial y_2}{\partial x_n}\\   \vdots&  \vdots &  \ddots & \vdots \\ \frac{\partial y_m}{\partial x_1}& \frac{\partial y_m}{\partial x_2} & \ldots & \frac{\partial y_m}{\partial x_n}  \end{array} \right)$$

    这个按分子布局的向量对向量求导的结果矩阵，我们一般叫做**雅克比 (Jacobian)**矩阵。有的资料上会使用$ \frac{\partial  \mathbf{y}}{\partial \mathbf{x^T}}$来定义雅克比矩阵。

  + 如果是按分母布局，则求导的结果矩阵的第一维度会以分母为准，即结果是一个$n \times m$的矩阵，如下：$$ \frac{\partial  \mathbf{y}}{\partial \mathbf{x}} = \left( \begin{array}{ccc} \frac{\partial y_1}{\partial x_1}& \frac{\partial y_2}{\partial x_1}& \ldots & \frac{\partial y_m}{\partial x_1}\\  \frac{\partial y_1}{\partial x_2}& \frac{\partial y_2}{\partial x_2} & \ldots & \frac{\partial y_m}{\partial x_2}\\   \vdots&  \vdots &  \ddots & \vdots \\ \frac{\partial y_1}{\partial x_n}& \frac{\partial y_2}{\partial x_n} & \ldots & \frac{\partial y_m}{\partial x_n}  \end{array} \right)$$

    这个按分母布局的向量对向量求导的结果矩阵，我们一般叫做**梯度矩阵**。有的资料上会使用$ \frac{\partial  \mathbf{y^T}}{\partial \mathbf{x}}​$来定义梯度矩阵

| 自变量\因变量      | 标量$y$                                                      | 列向量$\mathbf{y}$                                           | 矩阵$\mathbf{Y}$                                             |
| ------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 标量$x$            | /                                                            | $\frac{\partial  \mathbf{y}}{\partial x}$分子布局：m维列向量（默认布局）分母布局：m维行向量 | $\frac{\partial \mathbf{Y}}{\partial x}$分子布局：$p \times q$矩阵（默认布局）分母布局：$q \times p$矩阵 |
| 列向量$\mathbf{x}$ | $\frac{\partial y}{\partial \mathbf{x}}$分子布局：n维行向量分母布局：n维列向量（默认布局） | $\frac{\partial  \mathbf{y}}{\partial \mathbf{x}}$分子布局：$m \times n$雅克比矩阵（默认布局）分母布局：$n \times m$梯度矩阵 | /                                                            |
| 矩阵$\mathbf{X}$   | $\frac{\partial y}{\partial \mathbf{X}}$分子布局：$n \times m$矩阵分母布局：$m \times n$矩阵（默认布局） | /                                                            | /                                                            |



## 2 定义法

### 2.1 用定义法求解标量对向量求导

标量对向量求导，严格来说是实值函数对向量的求导。即定义实值函数$f: R^{n} \to R$,自变量$\mathbf{x}$是n维向量，而输出$y$是标量。对于一个给定的实值函数，如何求解$\frac{\partial y}{\partial \mathbf{x}}$呢？ 

根据矩阵求导的定义，由于所谓标量对向量的求导，其实就是标量对向量里的每个分量分别求导，最后把求导的结果排列在一起，按一个向量表示而已。那么我们可以将实值函数对向量的每一个分量来求导，最后找到规律，得到求导的结果向量。

例：$y=\mathbf{a}^T\mathbf{x}$,求解$\frac{\partial \mathbf{a}^T\mathbf{x}}{\partial \mathbf{x}}$

根据定义，我们先对$\mathbf{x}$的第i个分量进行求导，这是一个标量对标量的求导，如下：

$$\frac{\partial \mathbf{a}^T\mathbf{x}}{\partial x_i} = \frac{\partial \sum\limits_{j=1}^n a_jx_j}{\partial x_i} = \frac{\partial a_ix_i}{\partial x_i} =a_i$$

可见，对向量的第i个分量的求导结果就等于向量$\mathbf{a}$的第i个分量。由于我们是分母布局，最后所有求导结果的分量组成的是一个n维向量。那么其实就是向量$\mathbf{a}$。也就是说：$$\frac{\partial \mathbf{a}^T\mathbf{x}}{\partial \mathbf{x}} = \mathbf{a}$$

同样的思路，我们也可以直接得到：$$\frac{\partial \mathbf{x}^T\mathbf{a}}{\partial \mathbf{x}} = \mathbf{a}$$

再来看一个复杂一点点的例子：$y=\mathbf{x}^T\mathbf{A}\mathbf{x}$,求解$\frac{\partial \mathbf{x}^T\mathbf{A}\mathbf{x}}{\partial \mathbf{x}}$

我们对$\mathbf{x}$的第k个分量进行求导如下：

$$\frac{\partial \mathbf{x}^T\mathbf{A}\mathbf{x}}{\partial x_k} = \frac{\partial \sum\limits_{i=1}^n\sum\limits_{j=1}^n x_iA_{ij}x_j}{\partial x_k} = \sum\limits_{i=1}^n A_{ik}x_i + \sum\limits_{j=1}^n A_{kj}x_j $$

第一部分是矩阵$\mathbf{A}$的第k列转置后和$x$相乘得到，第二部分是矩阵$\mathbf{A}$的第k行和$x$相乘得到，排列好就是: $$\frac{\partial \mathbf{x}^T\mathbf{A}\mathbf{x}}{\partial \mathbf{x}} = \mathbf{A}^T\mathbf{x} + \mathbf{A}\mathbf{x}$$

从上面可以看出，定义法求导对于简单的实值函数是很容易的，但是复杂的实值函数就算求出了任意一个分量的导数，要排列出最终的求导结果还挺麻烦的，因此我们需要找到其他的简便一些的方法来整体求导，而不是每次都先去针对任意一个分量，再进行排列。

### 2.2 标量对向量求导的一些基本法则

1. 常量对向量的求导结果为0。
2. 线性法则：如果$f,g$都是实值函数，$c_1,c_2$为常数，则：$$\frac{\partial (c_1f(\mathbf{x})+c_2g(\mathbf{x})}{\partial \mathbf{x}} = c_1\frac{\partial f(\mathbf{x})}{\partial \mathbf{x}} +c_2\frac{\partial g(\mathbf{x})}{\partial \mathbf{x}} $$
3. 乘法法则：如果$f,g$都是**实值**函数，则：$$\frac{\partial f(\mathbf{x})g(\mathbf{x})}{\partial \mathbf{x}} = f(\mathbf{x})\frac{\partial g(\mathbf{x})}{\partial \mathbf{x}} +\frac{\partial f(\mathbf{x})}{\partial \mathbf{x}} g(\mathbf{x}) $$
	要注意的是如果不是实值函数，则不能这么使用乘法法则。

4. 除法法则：如果$f,g$都是实值函数，且$g(\mathbf{x}) \neq 0$，则：$$\frac{\partial f(\mathbf{x})/g(\mathbf{x})}{\partial \mathbf{x}} = \frac{1}{g^2(\mathbf{x})}(g(\mathbf{x})\frac{\partial f(\mathbf{x})}{\partial \mathbf{x}} - f(\mathbf{x})\frac{\partial g(\mathbf{x})}{\partial \mathbf{x}})$$

### 2.3 用定义法求解标量对矩阵求导

例: $y=\mathbf{a}^T\mathbf{X}\mathbf{b}$,求解$\frac{\partial \mathbf{a}^T\mathbf{X}\mathbf{b}}{\partial \mathbf{X}}$

其中, $\mathbf{a}$是m维向量,$\mathbf{b}$是n维向量,  $\mathbf{X}$是$m \times n$的矩阵

我们对矩阵$\mathbf{X}$的任意一个位置的$X_{ij}$求导，如下：$$\frac{\partial \mathbf{a}^T\mathbf{X}\mathbf{b}}{\partial X_{ij}} =  \frac{\partial \sum\limits_{p=1}^m\sum\limits_{q=1}^n a_pX_{pq}b_q}{\partial X_{ij}} =  \frac{\partial  a_iX_{ij}b_j}{\partial X_{ij}} = a_ib_j​$$

即求导结果在$(i.j)$位置的求导结果是$\mathbf{a}$向量第i个分量和$\mathbf{b}$第j个分量的乘积，将所有的位置的求导结果排列成一个$m \times n$的矩阵，即为$ab^T$,这样最后的求导结果为：$$\frac{\partial \mathbf{a}^T\mathbf{X}\mathbf{b}}{\partial \mathbf{X}} = ab^T$$

简单的求导的确不难，但是如果是比较复杂的标量对矩阵求导，比如$y=\mathbf{a}^Texp(\mathbf{X}\mathbf{b})$,对任意标量求导容易，排列起来还是蛮麻烦的，也就是我们遇到了和标量对向量求导一样的问题，定义法比较适合解决简单的问题，复杂的求导需要更简便的方法.

### 2.4 用定义法求解向量对向量求导

例: $\mathbf{y} = \mathbf{A} \mathbf{x} $,其中$ \mathbf{A}$为$n \times m$的矩阵。$\mathbf{x}, \mathbf{y}$分别为$m,n$维向量。需要求导$\frac{\partial \mathbf{A}\mathbf{x}}{\partial \mathbf{x}}$,根据定义，结果应该是一个$n \times m$的矩阵(分子布局 雅克比矩阵)

先求矩阵的第i行和向量的内积对向量的第j分量求导，用定义法求解过程如下：$$\frac{\partial \mathbf{A}\mathbf{x}}{\partial \mathbf{x}} = \frac{\partial \sum\limits_{i=1}^m \mathbf{A_i}\mathbf{x}}{\partial \mathbf{x_j}} = \frac{\partial \sum\limits_{i=1}^m \sum\limits_{j=1}^n A_{ij}x_j}{\partial \mathbf{x_j}}= A_{ij}$$

可见矩阵 $\mathbf{A}$的第i行和向量的内积对向量的第j分量求导的结果就是矩阵 $\mathbf{A}$的$(i,j)$位置的值。排列起来就是一个矩阵了，由于我们分子布局，所以排列出的结果是$ \mathbf{A}$,而不是 $\mathbf{A}^T$

来源:

- [机器学习中的矩阵求导](https://www.cnblogs.com/pinard/p/10750718.html)
- [通过一个例子快速上手矩阵求导](https://blog.csdn.net/nomadlx53/article/details/50849941)
- [矩阵求导、几种重要的矩阵及常用的矩阵求导公式](https://blog.csdn.net/daaikuaichuan/article/details/80620518)
